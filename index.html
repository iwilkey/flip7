<!--
    Flip 7 Console Web Applet

    SPDX-License-Identifier: MIT | Copyright © 2025 Ian Wilkey

    You may use, modify, and redistribute this software with attribution.
    This software is provided "as is", without warranty of any kind.
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Let's Play Flip 7™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <style>
        html,
        
        body {
            height: 100%;
            margin: 0;
        }
        body {
            min-height: 100dvh;
        }
        body {
            background: #111;
            color: #eee;
            font-family: monospace;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #console {
            padding: 16px;
            white-space: pre-wrap;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #console-content {
            margin-top: auto;
            padding-bottom: 12px;
        }

        #input,
        #button-input {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            border: none;
            outline: none;
            font-family: monospace;
            font-size: 16px;
            background: #222;
            color: #eee;
        }

        #button-input {
            display: none;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(13, 1fr);
            gap: 6px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .card-btn,
        .bust-btn,
        .done-btn,
        .menu-btn {
            padding: 12px 0;
            font-size: 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background: #333;
            color: #eee;
            transition: background 0.15s;
        }

        .menu-btn:hover {
            background: #444;
        }

        .card-btn.selected {
            background: #666;
        }

        .card-btn:hover:not(.selected) {
            background: #444;
        }

        .bust-btn {
            grid-column: 1 / -1;
            background: #7a2222;
        }

        .bust-btn:hover {
            background: #9a2a2a;
        }

        .done-btn {
            grid-column: 1 / -1;
            background: #225a22;
        }

        .done-btn:hover {
            background: #2f7a2f;
        }

        #input-bar {
            position: sticky;
            bottom: 0;
            background: #111;
        }

    </style>
</head>

<body>
    <div id="console"><div id="console-content"></div></div>
    <div id="input-bar">
        <input id="input" autocomplete="off" />
        <div id="button-input"></div>
    </div>
    <script>

        const F_CONSOLE = document.getElementById("console");
        const F_CONSOLE_CONTENT = document.getElementById("console-content");
        const F_INPUT_ELEMENT = document.getElementById("input");
        const F_BUTTON_ELEMENT = document.getElementById("button-input");
        const F_INPUT_BAR = document.getElementById("input-bar");
        const F_IS_TOUCH_DEVICE = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        let tqueue = Promise.resolve();

        window.addEventListener("orientationchange", () => {
            setTimeout(ensureScroll, 300);
        });

        if(window.visualViewport) {
            window.visualViewport.addEventListener("resize", () => {
                setTimeout(ensureScroll, 50);
            });
        }

        function ensureScroll() {
            requestAnimationFrame(() => {
                F_CONSOLE.scrollTop = F_CONSOLE.scrollHeight;
            });
        }

        function renderq(text, element, delay = 16) {
            return new Promise(resolve => {
                let i = 0;
                function typeChar() {
                    if(i < text.length) {
                        element.textContent += text[i];
                        i++;
                        ensureScroll();
                        setTimeout(typeChar, delay);
                    } else {
                        resolve();
                    }
                }
                typeChar();
            });
        }

        function print(text = "") {
            tqueue = tqueue.then(() => renderq(text + "\n", F_CONSOLE_CONTENT));
        }

        function printi(text = "") {
            tqueue = tqueue.then(() => renderq(text, F_CONSOLE_CONTENT));
        }

        function cls() {
            F_CONSOLE_CONTENT.textContent = "";
        }

        let state = "INIT_PLAYERS";
        let p = 0;
        let names = [];
        let sc = [];
        let wins = {};
        let r = 0;
        let cpp = 0;
        let scc = new Set();
        let busted = false;

        function rscores() {
            sc = new Array(p).fill(0);
            r = 0;
            cpp = 0;
            cls();
            print("New game started.");
            menu();
        }

        function bootstrap() {
            cls();
            state = "INIT_PLAYERS";
            p = 0;
            names = [];
            sc = [];
            r = 0;
            cpp = 0;
            F_INPUT_ELEMENT.disabled = false;
            F_BUTTON_ELEMENT.innerHTML = "";
            F_BUTTON_ELEMENT.style.display = "none";
            F_INPUT_ELEMENT.style.display = "block";
            print("Let's play Flip 7™");
            print(" ");
            print("Copyright © 2025 Ian Wilkey");
            print("Licensed under the MIT License; you may use, modify, and redistribute this software with attribution.");
            print(" ");
            print("This is intentionally a console-style application with minimal UI. When applicable, use the text field at the bottom and press Enter to submit input.");
            print(" ");
            printi("How many players? ");
        }

        bootstrap();

        F_INPUT_ELEMENT.addEventListener("keydown", e => {
            if(e.key !== "Enter") return;
            e.preventDefault();
            const input = F_INPUT_ELEMENT.value;
            F_INPUT_ELEMENT.value = "";
            print(input);
            inp(input);
        });

        function scards() {
            F_INPUT_ELEMENT.style.display = "none";
            F_BUTTON_ELEMENT.style.display = "block";
            F_BUTTON_ELEMENT.innerHTML = "";
            scc.clear();
            busted = false;
            const grid = document.createElement("div");
            grid.className = "button-grid";
            for(let i = 0; i <= 12; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.className = "card-btn";
                btn.onclick = () => {
                    btn.classList.toggle("selected");
                    btn.classList.contains("selected")
                        ? scc.add(i)
                        : scc.delete(i);
                };
                grid.appendChild(btn);
            }
            const bustBtn = document.createElement("button");
            bustBtn.textContent = "BUST";
            bustBtn.className = "bust-btn";
            bustBtn.onclick = () => {
                busted = true;
                print("BUST");
                frinp();
            };
            const doneBtn = document.createElement("button");
            doneBtn.textContent = "DONE";
            doneBtn.className = "done-btn";
            doneBtn.onclick = () => {
                print([...scc].sort((a, b) => a - b).join(" "));
                frinp();
            };
            grid.appendChild(bustBtn);
            grid.appendChild(doneBtn);
            F_BUTTON_ELEMENT.appendChild(grid);
            ensureScroll();
        }

        function smbut() {
            F_INPUT_ELEMENT.style.display = "none";
            F_BUTTON_ELEMENT.style.display = "block";
            F_BUTTON_ELEMENT.innerHTML = "";
            const grid = document.createElement("div");
            grid.className = "menu-grid";
            const actions = [
                ["New Round", () => {
                    cpp = 0;
                    state = "ROUND_INPUT";
                    printi(`Round ${r + 1}: ${names[cpp]}'s card values: `);
                    scards();
                }],
                ["See Standings", () => {
                    sstand();
                    menu();
                }],
                ["New Game", rscores]
            ];
            for(const [label, fn] of actions) {
                const btn = document.createElement("button");
                btn.textContent = label;
                btn.className = "menu-btn";
                btn.onclick = fn;
                grid.appendChild(btn);
            }
            F_BUTTON_ELEMENT.appendChild(grid);
            ensureScroll();
        }

        function hide() {
            F_BUTTON_ELEMENT.style.display = "none";
            F_INPUT_ELEMENT.style.display = "block";
            F_INPUT_ELEMENT.focus();
        }

        function frinp() {
            if (!busted) {
                let sum = 0;
                for(const v of scc) sum += v;
                sc[cpp] += sum;
                if(scc.size >= 7) sc[cpp] += 15;
            }
            cpp++;
            hide();
            if(cpp < p) {
                printi(`Round ${r + 1}: ${names[cpp]}'s card values: `);
                scards();
            } else {
                sstand();
                vwin();
            }
        }

        function inp(input) {
            if(state === "INIT_PLAYERS") {
                const n = Number(input);
                if(!Number.isInteger(n)) {
                    print("Invalid input. Please enter a number between 1 and 12.");
                    printi("How many players? ");
                    return;
                }
                if(n < 1 || n > 12) {
                    print("Invalid player count. Must be between 1 and 12.");
                    printi("How many players? ");
                    return;
                }
                p = n;
                sc = new Array(p).fill(0);
                names = [];
                cpp = 0;
                state = "GET_NAMES";
                printi(`Player ${cpp + 1} name: `);
            } else if (state === "GET_NAMES") {
                const name = input.trim();
                if(name.length === 0) {
                    print("Invalid name. Please enter at least one non-whitespace character.");
                    printi(`Player ${cpp + 1} name: `);
                    return;
                }
                if(names.includes(name)) {
                    print("That name is already taken. Please enter a unique name.");
                    printi(`Player ${cpp + 1} name: `);
                    return;
                }
                names.push(name);
                wins[name] ??= 0;
                cpp++;
                if(cpp < p) {
                    printi(`Player ${cpp + 1} name: `);
                } else {
                    state = "MENU";
                    if(F_IS_TOUCH_DEVICE) {
                        F_INPUT_ELEMENT.blur();
                    }
                    menu();
                }
            }
        }

        function vwin() {
            let max = 0, idx = -1;
            for(let i = 0; i < sc.length; i++) {
                if (sc[i] > max) { max = sc[i]; idx = i; }
            }
            if(max >= 200) {
                print(`${names[idx]} wins.`);
                wins[names[idx]]++;
                rscores();
            } else {
                r++;
                state = "MENU";
                menu();
            }
        }

        function menu() {
            print(" ");
            print("What would you like to do?");
            smbut();
        }

        function sstand() {
            print("Current Standings:");
            names
                .map(n => [sc[names.indexOf(n)], n])
                .sort((a, b) => b[0] - a[0])
                .forEach(([score, name]) =>
                    print(`${name}: ${score} (wins: ${wins[name]})`)
                );
        }

    </script>
</body>

</html>
